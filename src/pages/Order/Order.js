import React, { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useRecoilState } from 'recoil';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faStar, faCircleCheck } from '@fortawesome/free-solid-svg-icons';
import OrderRevModal from '../../components/Modal/OrderRevModal';
import { nanoid } from 'nanoid';
import { PAY_METHOD, SIMPLE_PAY_METHOD, PHONE_F } from '../../uiData/orderData';
import { date, count, time, allTime } from '../../recoilState';
import * as S from './StyleOrder';

const Order = () => {
  const [isOpenModal, setIsOpenModal] = useState(false);
  const [orderNow, setOrderNow] = useState(false);
  const [selectMethod, setSelectMethod] = useState(0);
  const [method, setMethod] = useState('');
  const [selectedDate, setSelectedDate] = useRecoilState(date);
  const [guestCount, setGuestCount] = useRecoilState(count);
  const [selectedTime, setSelectedTime] = useRecoilState(time);
  const [selectedAllTime, setSelectedAllTime] = useRecoilState(allTime);
  const [studioData, setStudioData] = useState({});
  const [userPhone, setUserPhone] = useState({});
  const [addPhone, setAddPhone] = useState(false);
  const [isPhoneUpdate, setIsPhoneUpdate] = useState(false);

  const [inputValues, setInputValues] = useState({
    phoneFir: '',
    phoneSec: '',
    phoneThr: '',
  });

  const navigate = useNavigate();

  const params = useParams();
  const studioId = params.id;

  const handleMethod = (id, method) => {
    setMethod(method);
    setSelectMethod(id);
  };

  const handleOrderBtn = () => {
    setOrderNow(prev => !prev);
    if (!orderNow) {
      handleTossApi();
    }
  };

  const handleRevUpdate = () => {
    setIsOpenModal(prev => !prev);
  };
  const handleTossApi = () => {
    const amount = studioData.studioPrice.toLocaleString().split('.');
    const bookingDate = selectedDate.toISOString().split('T');
    const timeSlot = `[${selectedTime}]`;

    fetch('https://api.tosspayments.com/v1/payments', {
      method: 'POST',
      headers: {
        Authorization:
          'Basic dGVzdF9za19CRTkyTEFhNVBWYlhOSzE3eERSODdZbXBYeUpqOg==',
        'Content-Type': 'application/json;charset=utf-8',
      },
      body: JSON.stringify({
        method: method,
        amount: Number(amount[0]),
        orderId: nanoid(),
        orderName: studioData.studioName,
        successUrl: `http://localhost:3000/order/${studioId}/req_success?amount=${Number(
          amount[0]
        )}&guest=${guestCount}&timeSlot=${timeSlot}&bookingDate=${
          bookingDate[0]
        }`,
        failUrl: `http://localhost:3000/order/${studioId}/req_fail`,
      }),
    })
      .then(response => response.json())
      .then(result => {
        if (result.paymentKey) {
          window.location.href = result.checkout.url;
        }
      });
  };

  useEffect(() => {
    fetch(`${process.env.REACT_APP_SERVER_HOST}/studios/details/${studioId}`)
      .then(response => response.json())
      .then(result => {
        setStudioData(result.data);
      });
  }, []);

  useEffect(() => {
    fetch(`${process.env.REACT_APP_SERVER_HOST}/users/phone`, {
      headers: {
        'Content-Type': 'application/json',
        Authorization: localStorage.getItem('accessToken'),
      },
    })
      .then(response => response.json())
      .then(result => {
        setUserPhone(result.data);
      });
  }, [isPhoneUpdate]);

  const handleMainLink = () => {
    navigate('/');
  };

  const ShowTime = () => {
    if (selectedAllTime.length === 0 || selectedAllTime[0] === -1) {
      return '';
    } else if (selectedAllTime.length === 1) {
      return `${selectedAllTime[0]}:00 ~ ${selectedAllTime[0] + 1}:00`;
    } else {
      return `${selectedAllTime[0]}:00 ~ ${
        selectedAllTime[selectedAllTime.length - 1]
      }:00`;
    }
  };

  const handlePhoneInput = e => {
    const { name, value } = e.target;
    setInputValues({ ...inputValues, [name]: value });
  };

  const savePhoneInput = () => {
    if (inputValues.phoneFir === null) {
      setInputValues({ ...inputValues, [inputValues.phoneFir]: '010' });
    }
    const phone =
      inputValues.phoneFir + inputValues.phoneSec + inputValues.phoneThr;

    fetch(`${process.env.REACT_APP_SERVER_HOST}/bookings/phone`, {
      headers: {
        'Content-Type': 'application/json',
        Authorization: localStorage.getItem('accessToken'),
      },
      method: 'PATCH',
      body: JSON.stringify({
        userPhoneNumber: phone,
      }),
    })
      .then(response => response.json())
      .then(result => {
        if (result.message === 'USER_PHONE_NUMBER_UPDATE_SUCCESS') {
          alert('Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§ üí´');
          setIsPhoneUpdate(prev => !prev);
        }
      });
  };

  if (!studioData.studioImages) return null;
  if (!userPhone) return null;

  const timeLength = selectedAllTime.length;
  const totalPrice = Number(studioData.studioPrice * timeLength);

  return (
    <S.StyleOrder>
      <S.OrderNav>
        <S.LogoImgDiv imgSrc="/images/logo_v1.png" onClick={handleMainLink} />
      </S.OrderNav>
      <S.OrderContainer>
        <S.OrderTitle>
          <S.OrderH2>ÌôïÏù∏ Î∞è Í≤∞Ï†ú</S.OrderH2>
        </S.OrderTitle>
        <S.OrderWrapper>
          <S.OrderLeft>
            <S.OrderInner>
              <S.OrderDiv>
                <S.MidSpan>ÏòàÏïΩ Ï†ïÎ≥¥</S.MidSpan>
                <S.RevTop>
                  <S.TopInnerLeft>
                    <S.SmallDiv>ÎÇ†Ïßú</S.SmallDiv>
                  </S.TopInnerLeft>
                  <S.TopInnerRight>
                    <S.ThinDiv>{selectedDate.toLocaleDateString()}</S.ThinDiv>
                  </S.TopInnerRight>
                </S.RevTop>
                <S.RevTop>
                  <S.TopInnerLeft>
                    <S.SmallDiv>ÏãúÍ∞Ñ</S.SmallDiv>
                  </S.TopInnerLeft>
                  <S.TopInnerRight>
                    <S.ThinDiv>{ShowTime()}</S.ThinDiv>
                  </S.TopInnerRight>
                </S.RevTop>
                <S.RevTop>
                  <S.TopInnerLeft>
                    <S.SmallDiv>Ïù∏Ïõê</S.SmallDiv>
                  </S.TopInnerLeft>
                  <S.TopInnerRight>
                    <S.ThinDiv>{guestCount}</S.ThinDiv>
                  </S.TopInnerRight>
                </S.RevTop>
                <S.RevTop>
                  <S.TopInnerLeft />
                  <S.TopInnerRight>
                    <S.UpdateBtn onClick={handleRevUpdate}>
                      ÏòàÏïΩÏ†ïÎ≥¥ ÏàòÏ†ï
                    </S.UpdateBtn>
                  </S.TopInnerRight>
                </S.RevTop>
              </S.OrderDiv>
              <S.OrderDiv>
                <S.MidSpan>Í≤∞Ï†ú ÏàòÎã®</S.MidSpan>
                <S.RevTop>
                  {PAY_METHOD.map(pay => {
                    return (
                      <S.MethodBtn
                        key={pay.id}
                        onClick={() => {
                          handleMethod(pay.id, pay.method);
                        }}
                        isActive={pay.id === selectMethod}
                      >
                        {pay.name}
                      </S.MethodBtn>
                    );
                  })}
                  {SIMPLE_PAY_METHOD.map(pay => {
                    return (
                      <S.SimpleMethodBtn
                        imgUrl={pay.imgUrl}
                        key={pay.id}
                        onClick={() => {
                          handleMethod(pay.id, pay.method);
                        }}
                        isActive={pay.id === selectMethod}
                      />
                    );
                  })}
                </S.RevTop>
              </S.OrderDiv>
              {!userPhone[0]?.phoneNumber && (
                <S.OrderDiv>
                  <S.MidSpan>ÌïÑÏàò ÏûÖÎ†• Ï†ïÎ≥¥</S.MidSpan>

                  <S.RevTop>
                    <S.TopInnerLeft>
                      <S.SmallDiv>Ï†ÑÌôîÎ≤àÌò∏</S.SmallDiv>
                      <S.ThinDiv>
                        Ïó¨Ìñâ ÏóÖÎç∞Ïù¥Ìä∏Î•º Î∞õÏúºÎ†§Î©¥ Ï†ÑÌôîÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÍ≥†
                        Ïù∏Ï¶ùÌï¥Ï£ºÏÑ∏Ïöî
                      </S.ThinDiv>
                    </S.TopInnerLeft>
                    <S.TopInnerRight>
                      {!addPhone && (
                        <S.AddBtn
                          onClick={() => {
                            setAddPhone(prev => !prev);
                          }}
                        >
                          Ï∂îÍ∞Ä
                        </S.AddBtn>
                      )}
                    </S.TopInnerRight>
                  </S.RevTop>
                  {addPhone && (
                    <S.RevTop>
                      <S.TopInnerLeft>
                        <S.PhoneSelect
                          onChange={handlePhoneInput}
                          name="phoneFir"
                        >
                          {PHONE_F.map(phone => {
                            return (
                              <option key={phone.id}>{phone.value}</option>
                            );
                          })}
                        </S.PhoneSelect>
                        -
                        <S.PhoneInput
                          maxLength="4"
                          name="phoneSec"
                          onChange={handlePhoneInput}
                        />
                        -
                        <S.PhoneInput
                          maxLength="4"
                          name="phoneThr"
                          onChange={handlePhoneInput}
                        />
                      </S.TopInnerLeft>
                      <S.TopInnerRight>
                        <S.PhoneBtn onClick={savePhoneInput}>Ï†ÄÏû•</S.PhoneBtn>
                      </S.TopInnerRight>
                    </S.RevTop>
                  )}
                </S.OrderDiv>
              )}
              {userPhone[0]?.phoneNumber && (
                <S.OrderDiv>
                  <S.MidSpan>ÌïÑÏàò ÏûÖÎ†• Ï†ïÎ≥¥</S.MidSpan>

                  <S.RevTop>
                    <S.TopInnerLeft>
                      <S.SmallDiv>Ï†ÑÌôîÎ≤àÌò∏</S.SmallDiv>
                      <S.SmallDiv>
                        {userPhone[0]?.phoneNumber.substr(0, 3) +
                          '-' +
                          userPhone[0]?.phoneNumber.substr(3, 4) +
                          '-' +
                          userPhone[0]?.phoneNumber.substr(7, 4)}
                      </S.SmallDiv>
                    </S.TopInnerLeft>
                    <S.TopInnerRight>
                      <S.PhoneSaveBtn>
                        <FontAwesomeIcon icon={faCircleCheck} />
                      </S.PhoneSaveBtn>
                    </S.TopInnerRight>
                  </S.RevTop>
                </S.OrderDiv>
              )}
              <S.OrderDiv>
                <S.MidSpan>ÌôòÎ∂à Ï†ïÏ±Ö</S.MidSpan>
                <S.RevTop>
                  <S.ThinDiv>
                    <S.BoldSpan>
                      7Ïõî 17Ïùº Ï†ÑÍπåÏßÄ Î¨¥Î£åÎ°ú Ï∑®ÏÜåÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.
                    </S.BoldSpan>
                    Ï≤¥ÌÅ¨Ïù∏ ÎÇ†ÏßúÏù∏ 7Ïõî 22Ïùº Ï†ÑÏóê Ï∑®ÏÜåÌïòÎ©¥ Î∂ÄÎ∂ÑÌôòÎ∂àÏùÑ Î∞õÏúºÏã§ Ïàò
                    ÏûàÏäµÎãàÎã§.
                    <S.MoreLink to="/"> ÏûêÏÑ∏Ìûà ÏïåÏïÑÎ≥¥Í∏∞</S.MoreLink>
                  </S.ThinDiv>
                </S.RevTop>
              </S.OrderDiv>
              <S.OrderDiv>
                <S.MidSpan>Í∏∞Î≥∏ Í∑úÏπô</S.MidSpan>
                <S.ThinDiv>
                  <S.BoldSpan>
                    ÌõåÎ•≠Ìïú Í≤åÏä§Ìä∏Í∞Ä ÎêòÍ∏∞ ÏúÑÌïú Î™áÍ∞ÄÏßÄ Í∞ÑÎã®Ìïú Í∑úÏπô
                  </S.BoldSpan>
                  ÏùÑ ÏßÄÏºúÏ£ºÏã§ Í≤ÉÏùÑ Î™®Îì†Î∂ÑÎì§ÏóêÍ≤å ÎãπÎ∂ÄÎìúÎ¶ΩÎãàÎã§.
                </S.ThinDiv>
                <br />
                <S.ThinDiv>
                  ¬∑ ÏÇ¨Ïö©ÌïòÏã† Î¨ºÌíàÏùÄ Ìá¥Ïã§ Ïãú ÏõêÎûò ÏûêÎ¶¨Î°ú Î∞∞Ïπò Î∂ÄÌÉÅÎìúÎ¶ΩÎãàÎã§
                </S.ThinDiv>
                <S.ThinDiv>¬∑ Ïä§ÌäúÎîîÏò§ÎèÑ ÏûêÏã†Ïùò ÏßëÏ≤òÎüº ÏïÑÍª¥Ï£ºÏÑ∏Ïöî.</S.ThinDiv>
              </S.OrderDiv>
            </S.OrderInner>
          </S.OrderLeft>
          <S.OrderRight>
            <S.OrderRightInner>
              <S.Header>
                <S.ImgDiv imgSrc={studioData.studioImages[0]} />
                <S.HeaderInner>
                  <S.H2>{studioData.studioName}</S.H2>
                  <S.DescDiv>{studioData.studioAddress}</S.DescDiv>
                  <S.SmallSpan>
                    <S.Star>
                      <FontAwesomeIcon icon={faStar} />
                    </S.Star>
                    {studioData.averageRating}
                    <S.GraySpan>(ÌõÑÍ∏∞ {studioData.ratingCount}Í∞ú)</S.GraySpan>
                  </S.SmallSpan>
                </S.HeaderInner>
              </S.Header>
              <S.OrderAmountDiv>
                <S.MidSpan>Í≤∞Ï†úÏòàÏ†ïÍ∏àÏï°</S.MidSpan>
                <S.RevTop>
                  <S.TopInnerLeft>
                    <div>Ï¥ù Ìï©Í≥Ñ(KRW)</div>
                  </S.TopInnerLeft>
                  <S.TopInnerRight>
                    <div>{totalPrice.toLocaleString('en')}</div>
                  </S.TopInnerRight>
                </S.RevTop>
                <S.OrderBtn onClick={handleOrderBtn}>Í≤∞Ï†úÌïòÍ∏∞</S.OrderBtn>
              </S.OrderAmountDiv>
            </S.OrderRightInner>
          </S.OrderRight>
        </S.OrderWrapper>
      </S.OrderContainer>
      {isOpenModal && (
        <OrderRevModal
          isOpenModal={isOpenModal}
          handleModal={handleRevUpdate}
          studioId={studioId}
        />
      )}
    </S.StyleOrder>
  );
};

export default Order;
